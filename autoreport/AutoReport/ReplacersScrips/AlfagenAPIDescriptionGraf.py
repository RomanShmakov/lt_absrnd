import os
import re
import time

import urllib3
import yaml
import requests
# config
from constants import (CONFIG_NAME)

# config #
base_path = '.'
config_file = os.path.join(base_path, CONFIG_NAME)
config = yaml.safe_load(open(config_file, 'r'))

# –û—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–º SSL-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

api_key = config["alfagen_api_key"]


def get_description_for_table(table_error_data, purpose_graf, purpose_test):
    # –ø–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –æ—Ç –ò–ò
    description = post_request_to_llm_table(table_error_data, purpose_graf, purpose_test)
    return description


def get_description_for_graf(image_name, purpose_graf, purpose_test):
    # –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª

    # –ø–æ–ª—É—á–∞–µ–º taskId —Ñ–∞–π–ª–∞
    task_id = post_file_image_taskId(image_name)
    # task_id = '827c8ad7-7d95-4363-bcfd-f7f1721bde4e'

    # –ø–æ–ª—É—á–∞–µ–º fileId —Ñ–∞–π–ª–∞
    file_id = get_file_image_fileId(task_id)
    # file_id = '199869ed-df30-431b-b8ca-b736a58e354a'
    # –ø–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –æ—Ç –ò–ò
    description = post_request_to_llm(purpose_graf, purpose_test, file_id)
    return description


# 1
def post_file_image_taskId(image_name):
    file_path = image_name

    url = "https://agenapisandbox.moscow.alfaintra.net/internal/llm/v1/upload-file"
    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    files = {
        "file": (file_path, open(file_path, "rb"), "image/png")
    }
    # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ API key –≤ grafana
    headers = {
        "systemId": "sanduser",
        "Authorization": api_key,
    }
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
    try:
        response = requests.post(url, files=files, headers=headers, verify=False, timeout=300)
        response.raise_for_status()  # –í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–¥–æ–≤ 4xx/5xx
        print("–£—Å–ø–µ—à–Ω–æ! –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:")
        print(response.json())
    except requests.exceptions.RequestException as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    return response.json()["taskId"]


# 2
def get_file_image_fileId(task_id):
    url = f"https://agenapisandbox.moscow.alfaintra.net/internal/llm/v1/upload-file/{task_id}/sse"
    # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ API key –≤ grafana
    headers = {
        "systemId": "sanduser",
        "Authorization": api_key
    }
    isNotCompleted = True
    while isNotCompleted:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
        try:
            response = requests.get(url, headers=headers, verify=False, timeout=300)
            response.raise_for_status()  # –í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–¥–æ–≤ 4xx/5xx
            print("–£—Å–ø–µ—à–Ω–æ! –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:")
            print(response.json())
        except requests.exceptions.RequestException as e:
            print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

        # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è status
        status_pattern = r'"status":"([^"]*)"'
        status_match = re.search(status_pattern, response.text)
        if status_match:
            status = status_match.group(1)
            print(f"Status: {status}")

        if status == "COMPLETED":
            # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è fileId
            fileid_pattern = r'"fileId":"([^"]*)"'
            fileid_match = re.search(fileid_pattern, response.text)
            if fileid_match:
                file_id = fileid_match.group(1)
                print(f"File ID: {file_id}")
            return file_id
        else:
            time.sleep(30)


# 3
def post_request_to_llm(purpose_graf, purpose_test, file_id):
    url = "https://agenapisandbox.moscow.alfaintra.net/internal/llm/v1/chat/completions"
    headers = {
        "systemId": "sanduser",
        "Authorization": api_key,
        "Content-Type": "application/json"
    }

    # –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    data = {
        "model": "qwen-2.5-32b-vl",
        "n": 1,
        "messages": [
            {
                "role": "user",
                "content": [
                    {
                        "type": "text",
                        "text": "–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –≤–µ–¥—É—â–∏–π –∏–Ω–∂–µ–Ω–µ—Ä –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ –≥—Ä–∞—Ñ–∏–∫–∞–º –∏ –¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥—Ä–∞—Ñ–∏–∫—É –∏ –µ–≥–æ —Ç–∞–π–º—Å—Ç–∞–º–ø–∞–º; –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –≤—ã–¥–∞–π –≤—ã–≤–æ–¥—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (—Å–º. –Ω–∏–∂–µ)."
                    },
                    {
                        "type": "text",
                        "text": "–ü—Ä–∞–≤–∏–ª–∞ –∏ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π): 1. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 1.1. –ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ (–î–∞ / –ù–µ—Ç ‚Äî –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è), 1.2. –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ –º–µ—Ç—Ä–∏–∫–∏), 1.3. –û—Ü–µ–Ω–∫–∞ —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è / —É–º–µ—Ä–µ–Ω–Ω–∞—è / –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è), 1.4. –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö, 1.5. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å–º–µ–∂–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–ø–∏—Å–æ–∫), 1.6. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–µ—Ä–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –Ω—É–º–µ—Ä—É–π. 2. –ë—É–¥—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω: —É–∫–∞–∑—ã–≤–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Å 12:10 –¥–æ 12:35¬ª), –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ 30%¬ª), –∏ –∫–∞–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ —É–≤–∏–¥–µ–ª (–ø–∞–¥–µ–Ω–∏–µ RPS, —Ä–æ—Å—Ç latency, —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫ –∏ —Ç.–ø.). 3. –ù–µ –¥–∞–≤–∞–π –¥–ª–∏–Ω–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —Å–∂–∞—Ç–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º. –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞, –ø–æ–º–µ—Ç—å –∫–∞–∫ –≥–∏–ø–æ—Ç–µ–∑–∞ –∏ –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. 4. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–æ–º–∞–ª–∏—é, –ø–µ—Ä–µ—á–∏—Å–ª–∏ 3‚Äì5 —Å–º–µ–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫/–≥—Ä–∞—Ñ–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: latency P95, error rate, CPU –Ω–∞ –Ω–æ–¥–∞—Ö, GC pause time, queue length), –∏ –∫—Ä–∞—Ç–∫–æ ‚Äî –∑–∞—á–µ–º. 5. –ù–µ –¥–µ–ª–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –±–µ–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Ç—Ä–∏–∫–∞–º ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–º–µ—á–∞–π –∫–∞–∫ ¬´–≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞¬ª."
                    },
                    {
                        "type": "text",
                        "text": "–ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä): 1. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: RPS (ExecuteDataQuery, ExecuteQuery, BeginTransaction, CommitTransaction) —Å—Ç–∞–±–∏–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –ø–æ–¥–∞–≤–∞–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –ø–æ –≤—Å–µ–º—É —Ç–µ—Å—Ç—É. –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∞–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –í—ã–≤–æ–¥: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –Ω–µ—Ç.¬ª 2. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: RPS —É–ø–∞–ª–∞ –Ω–∞ ~90% –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç–µ—Å—Ç–∞ (—Å 12:15 –¥–æ 12:25). –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: error rate, downstream service availability, –ª–æ–≥–∏ –Ω–∞ –≤—Ä–µ–º—è –ø–∞–¥–µ–Ω–∏—è.¬ª 3. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: ExecuteDataQuery –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞ ‚Äî –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É –º–µ—Ç—Ä–∏–∫–∏ ExecuteQuery/BeginTransaction/CommitTransaction –ø—Ä–æ—Å–µ–ª–∏ –Ω–∞ 20‚Äì50%. –ò–Ω—Ç–µ—Ä–≤–∞–ª: 12:05‚Äì12:20. –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: latency P95/P99, error rate, CPU –∏ GC –Ω–∞ DB-–Ω–æ–¥–∞—Ö.¬ª"
                    },
                    {
                        "type": "text",
                        "text": f"–í–æ–ø—Ä–æ—Å (–∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞): {purpose_graf} {purpose_test}. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –∏ –æ—Ç–≤–µ—Ç—å –ø–æ —Ñ–æ—Ä–º–∞—Ç—É: 1. –ï—Å—Ç—å –ª–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è? 2. –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏. 3. –°—Ç–µ–ø–µ–Ω—å —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏. 4. –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (0‚Äì100%). 5. 3‚Äì5 —Å–º–µ–∂–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∏ –ø–æ—á–µ–º—É). 6. –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."
                    },
                    {
                        "type": "file",
                        "file": {
                            "file_id": f"{file_id}"
                        }
                    }
                ]
            }
        ]
    }

    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä json –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        response = requests.post(url, json=data, headers=headers, timeout=300, verify=False)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
        if response.status_code == 200:
            print("‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            result = response.json()
            result_content = result["choices"][0]["message"]["content"]
            return result_content
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.text}")
            return None

    except requests.exceptions.RequestException as e:
        print(f"üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
        return None


def post_request_to_llm_table(purpose_graf, purpose_test, file_id):
    url = "https://agenapisandbox.moscow.alfaintra.net/internal/llm/v1/chat/completions"
    headers = {
        "systemId": "sanduser",
        "Authorization": api_key,
        "Content-Type": "application/json"
    }

    # –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    data = {
        "model": "qwen-2.5-32b-vl",
        "n": 1,
        "messages": [
            {
                "role": "user",
                "content": [
                    {
                        "type": "text",
                        "text": "–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –≤–µ–¥—É—â–∏–π –∏–Ω–∂–µ–Ω–µ—Ä –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ –≥—Ä–∞—Ñ–∏–∫–∞–º –∏ –¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥—Ä–∞—Ñ–∏–∫—É –∏ –µ–≥–æ —Ç–∞–π–º—Å—Ç–∞–º–ø–∞–º; –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –≤—ã–¥–∞–π –≤—ã–≤–æ–¥—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (—Å–º. –Ω–∏–∂–µ)."
                    },
                    {
                        "type": "text",
                        "text": "–ü—Ä–∞–≤–∏–ª–∞ –∏ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π): 1. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 1.1. –ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ (–î–∞ / –ù–µ—Ç ‚Äî –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è), 1.2. –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ –º–µ—Ç—Ä–∏–∫–∏), 1.3. –û—Ü–µ–Ω–∫–∞ —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è / —É–º–µ—Ä–µ–Ω–Ω–∞—è / –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è), 1.4. –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö, 1.5. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å–º–µ–∂–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–ø–∏—Å–æ–∫), 1.6. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–µ—Ä–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –Ω—É–º–µ—Ä—É–π. 2. –ë—É–¥—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω: —É–∫–∞–∑—ã–≤–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Å 12:10 –¥–æ 12:35¬ª), –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ 30%¬ª), –∏ –∫–∞–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ —É–≤–∏–¥–µ–ª (–ø–∞–¥–µ–Ω–∏–µ RPS, —Ä–æ—Å—Ç latency, —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫ –∏ —Ç.–ø.). 3. –ù–µ –¥–∞–≤–∞–π –¥–ª–∏–Ω–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —Å–∂–∞—Ç–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º. –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞, –ø–æ–º–µ—Ç—å –∫–∞–∫ –≥–∏–ø–æ—Ç–µ–∑–∞ –∏ –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. 4. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–æ–º–∞–ª–∏—é, –ø–µ—Ä–µ—á–∏—Å–ª–∏ 3‚Äì5 —Å–º–µ–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫/–≥—Ä–∞—Ñ–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: latency P95, error rate, CPU –Ω–∞ –Ω–æ–¥–∞—Ö, GC pause time, queue length), –∏ –∫—Ä–∞—Ç–∫–æ ‚Äî –∑–∞—á–µ–º. 5. –ù–µ –¥–µ–ª–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –±–µ–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Ç—Ä–∏–∫–∞–º ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–º–µ—á–∞–π –∫–∞–∫ ¬´–≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞¬ª."
                    },
                    {
                        "type": "text",
                        "text": "–ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä): 1. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: RPS (ExecuteDataQuery, ExecuteQuery, BeginTransaction, CommitTransaction) —Å—Ç–∞–±–∏–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –ø–æ–¥–∞–≤–∞–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –ø–æ –≤—Å–µ–º—É —Ç–µ—Å—Ç—É. –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∞–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –í—ã–≤–æ–¥: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –Ω–µ—Ç.¬ª 2. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: RPS —É–ø–∞–ª–∞ –Ω–∞ ~90% –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç–µ—Å—Ç–∞ (—Å 12:15 –¥–æ 12:25). –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: error rate, downstream service availability, –ª–æ–≥–∏ –Ω–∞ –≤—Ä–µ–º—è –ø–∞–¥–µ–Ω–∏—è.¬ª 3. ¬´–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: ExecuteDataQuery –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞ ‚Äî –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É –º–µ—Ç—Ä–∏–∫–∏ ExecuteQuery/BeginTransaction/CommitTransaction –ø—Ä–æ—Å–µ–ª–∏ –Ω–∞ 20‚Äì50%. –ò–Ω—Ç–µ—Ä–≤–∞–ª: 12:05‚Äì12:20. –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: latency P95/P99, error rate, CPU –∏ GC –Ω–∞ DB-–Ω–æ–¥–∞—Ö.¬ª"
                    },
                    {
                        "type": "text",
                        "text": f"–í–æ–ø—Ä–æ—Å (–∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞): {purpose_test}. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –∏ –æ—Ç–≤–µ—Ç—å –ø–æ —Ñ–æ—Ä–º–∞—Ç—É: 1. –ï—Å—Ç—å –ª–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è? 2. –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏. 3. –°—Ç–µ–ø–µ–Ω—å —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏. 4. –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (0‚Äì100%). 5. 3‚Äì5 —Å–º–µ–∂–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∏ –ø–æ—á–µ–º—É). 6. –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."
                    },
                    {
                        "type": "text",
                        "text": purpose_graf
                    }
                ]
            }
        ]
    }

    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä json –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        response = requests.post(url, json=data, headers=headers, timeout=300, verify=False)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
        if response.status_code == 200:
            print("‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            result = response.json()
            result_content = result["choices"][0]["message"]["content"]
            return result_content
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.text}")
            return None

    except requests.exceptions.RequestException as e:
        print(f"üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
        return None
